stages:
  - nullplatform-asset-docker-image-build-and-push

variables:
  DOCKER_HOST: "tcp://127.0.0.1:2375"

nullplatform-asset-docker-image-build-and-push:
  image: docker:stable
  stage: nullplatform-asset-docker-image-build-and-push
  services:
    - docker:dind
  before_script:
    - apk add --no-cache python3 py3-pip openssl
    - pip3 install --no-cache-dir awscli
  script:
    - openssl enc -d -iter 1000 -aes-256-cbc -in assets-to-create.txt.enc -out assets-to-create.txt -k "$NULLPLATFORM_ENCRIPTION_KEY"
    - |+ 
      while IFS= read -r line; do
        for env_var in $line 
        do
          echo $env_var
          export "$env_var"
        done
        echo $AWS_DEFAULT_REGION
        echo $AWS_SECRET_ACCESS_KEY
        aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
        docker build -t $ASSET_URL .
        docker push $ASSET_URL
      done < assets-to-create.txt
